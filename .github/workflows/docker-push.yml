name: Docker Image Sync (Multi-Arch)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    # 这里定义手动触发时的输入参数
    inputs:
      source_image:
        description: '源镜像地址 (例如 ghcr.io/stsix/leaflow-checkin:latest)'
        required: true
        default: 'ghcr.io/stsix/leaflow-checkin:latest'
      target_repo:
        description: '推送到 Docker Hub 的仓库名 (不含用户名)'
        required: true
        default: 'leaflow-checkin'
      target_tag:
        description: '镜像标签 (Tag)'
        required: true
        default: 'latest'

jobs:
  copy_image:
    runs-on: ubuntu-latest

    steps:
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Sync Image
      run: |
        # 使用环境变量来处理参数，确保不管是手动触发还是 push 触发都有默认值
        SOURCE="${{ github.event.inputs.source_image || 'ghcr.io/stsix/leaflow-checkin:latest' }}"
        TARGET_REPO="${{ github.event.inputs.target_repo || 'leaflow-checkin' }}"
        TARGET_TAG="${{ github.event.inputs.target_tag || 'latest' }}"
        
        echo "正在同步: $SOURCE -> ${{ secrets.DOCKERHUB_USERNAME }}/$TARGET_REPO:$TARGET_TAG"
        
        docker buildx imagetools create \
          --tag ${{ secrets.DOCKERHUB_USERNAME }}/$TARGET_REPO:$TARGET_TAG \
          $SOURCE
